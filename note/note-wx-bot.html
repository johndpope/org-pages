<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-12-21 Fri 00:13 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>微信机器人</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="../css/worg.css" type="text/css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<a href="https://www.manue1.site/index.html">Home</a>
</div>
<div id="content">
<h1 class="title">微信机器人</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org707d546">note-robot</a>
<ul>
<li><a href="#org89ae6d8">install wxpy example</a></li>
<li><a href="#org8ab395e"><span class="todo TODO">TODO</span> list</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org707d546" class="outline-2">
<h2 id="org707d546">note-robot</h2>
<div class="outline-text-2" id="text-org707d546">
<p>
微信机器人wxpy是在itchat的基础上,通过大量接口优化提升了模块的易用性，
</p>

<p>
并进行丰富的功能扩展
</p>

<p>
<a href="https://github.com/youfou/wxpy">项目主页</a>
</p>

<p>
研究这个微信接口的目的，主要还是对机器人可以在一个管理群里查看，日志，远程执行命令感兴趣
</p>
</div>

<div id="outline-container-org89ae6d8" class="outline-3">
<h3 id="org89ae6d8">install wxpy example</h3>
<div class="outline-text-3" id="text-org89ae6d8">
<ol class="org-ol">
<li><p>
机器人实例 
</p>

<p>
下载地址 <a href="https://gist.github.com/youfou/03c1e0204ac092f873730f51671ce0a8">download</a>
</p></li>

<li><p>
开发环境
</p>

<p>
最新项目源码采用 <a href="https://stackoverflow.com/questions/42662104/how-to-install-pip-for-python-3-6-on-ubuntu-16-10/44254088#44254088a">python3 环境</a>
</p>
<p class="verse">
sudo add-apt-repository ppa:jonathonf/python-3.6<br />
sudo apt-get update<br />
sudo apt install python3.6<br />
sudo apt install python3.6-dev<br />
安装pip3<br />
wget <a href="https://bootstrap.pypa.io/get-pip.py">https://bootstrap.pypa.io/get-pip.py</a><br />
sudo python3.6 get-pip.py<br />
sudo ln -s /usr/bin/python3.6 /usr/local/bin/python<br />
sudo ln -s /usr/bin/python3.6 /usr/local/bin/python3<br />
sudo ln -s /usr/local/bin/pip3 /usr/local/bin/pip<br />
<br />
rm /usr/bin/python3 -f<br />
sudo ln -s /usr/bin/python3.6 /usr/bin/python3<br />
</p>

<ol class="org-ol">
<li><p>
个人运行中的机器人<a href="https://github.com/Nanue1/wxpy-exampe">源码</a>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python3</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">coding: utf-8</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">pip3 install -U git+https://github.com/youfou/wxpy.git@develop</span>
<span style="color: #8b2252;">pip3 install -U psutil</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> re
<span style="color: #a020f0;">import</span> subprocess
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">from</span> collections <span style="color: #a020f0;">import</span> Counter
<span style="color: #a020f0;">from</span> functools <span style="color: #a020f0;">import</span> wraps
<span style="color: #a020f0;">from</span> pprint <span style="color: #a020f0;">import</span> pformat
<span style="color: #a020f0;">import</span> psutil
<span style="color: #a020f0;">from</span> wxpy <span style="color: #a020f0;">import</span> *
<span style="color: #a020f0;">from</span> wxpy.utils <span style="color: #a020f0;">import</span> get_text_without_at_bot, start_new_thread
<span style="color: #a020f0;">from</span> kick_votes <span style="color: #a020f0;">import</span> KickVotes
<span style="color: #a020f0;">from</span> timed_list <span style="color: #a020f0;">import</span> TimedList

<span style="color: #b22222;"># </span><span style="color: #b22222;">---------------- &#37197;&#32622;&#24320;&#22987; ----------------</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Bot &#23545;&#35937;&#21021;&#22987;&#21270;&#26102;&#30340; console_qr &#21442;&#25968;&#20540;</span>
<span style="color: #a0522d;">console_qr</span> = 1

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26426;&#22120;&#20154;&#26165;&#31216; (&#38450;&#27490;&#30331;&#38169;&#36134;&#21495;)</span>
<span style="color: #a0522d;">bot_nick_name</span> = <span style="color: #8b2252;">'manue1'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20837;&#32676;&#21475;&#20196;</span>
<span style="color: #a0522d;">group_code</span> = <span style="color: #8b2252;">'&#22079;&#21704;'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31649;&#29702;&#21592;&#65292;&#21487;&#20026;&#22810;&#20010;&#65292;&#29992;&#20110;&#25191;&#34892;&#31649;&#29702;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39318;&#20010;&#31649;&#29702;&#21592;&#20026;"&#31995;&#32479;&#31649;&#29702;&#21592;"&#65292;&#21487;&#25509;&#25910;&#24322;&#24120;&#26085;&#24535;&#21644;&#25191;&#34892;&#26381;&#21153;&#31471;&#25805;&#20316;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20854;&#20182;&#31649;&#29702;&#21592;&#20165;&#25191;&#34892;&#24494;&#20449;&#32676;&#31649;&#29702;</span>
<span style="color: #a0522d;">admin_mangers_name</span> = [<span style="color: #8b2252;">'manue1'</span>,<span style="color: #8b2252;">'&#34636;&#34474;'</span>]


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31649;&#29702;&#32676;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20165;&#20026;&#19968;&#20010;&#65292;&#29992;&#20110;&#25509;&#25910;&#24515;&#36339;&#19978;&#25253;&#31561;&#27425;&#35201;&#20449;&#24687;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#21457;&#27979;&#35797; admins</span>
<span style="color: #a0522d;">admin_group_name</span> = <span style="color: #8b2252;">'&#24320;&#21457;&#27979;&#35797;'</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38656;&#31649;&#29702;&#30340;&#24494;&#20449;&#32676;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20026;&#22810;&#20010;&#65292;&#26426;&#22120;&#20154;&#24517;&#39035;&#20026;&#32676;&#20027;&#65292;&#21542;&#21017;&#26080;&#27861;&#25191;&#34892;&#30456;&#24212;&#25805;&#20316;</span>

<span style="color: #a0522d;">groups_name</span> = [<span style="color: #8b2252;">'&#27979;&#35797;2'</span>]


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#21160;&#22238;&#31572;&#20851;&#38190;&#35789;</span>
<span style="color: #a0522d;">kw_replies</span> = {
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'reply1'</span>: (
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'&#31119;&#21033;'</span>, <span style="color: #8b2252;">'&#20070;&#31821;'</span>, <span style="color: #8b2252;">'&#30005;&#24433;'</span>, <span style="color: #8b2252;">'&#32593;&#31449;'</span>
<span style="background-color: #f2f2f2;"> </span>   ),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'reply2'</span>: (
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'&#31119;&#21033;'</span>, <span style="color: #8b2252;">'&#20070;&#31821;'</span>, <span style="color: #8b2252;">'&#30005;&#24433;'</span>, <span style="color: #8b2252;">'&#32593;&#31449;'</span>
<span style="background-color: #f2f2f2;"> </span>   ),
<span style="color: #b22222;">#    </span><span style="color: #b22222;">'&#24517;&#30475;: &#24120;&#35265;&#38382;&#39064; FAQ:\nwxpy.readthedocs.io/faq.html': (</span>
<span style="color: #b22222;">#        </span><span style="color: #b22222;">'faq', '&#24120;&#35265;', '&#38382;&#39064;', '&#38382;&#31572;', '&#20160;&#20040;'</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">),</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">'@fil@{}'.format(__file__): (</span>
<span style="color: #b22222;">#        </span><span style="color: #b22222;">'&#28304;&#30721;', '&#20195;&#30721;'</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">)</span>
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#20154;&#20837;&#32676;&#30340;&#27426;&#36814;&#35821;</span>
<span style="color: #a0522d;">welcome_text</span> = <span style="color: #8b2252;">'''&#127881; &#27426;&#36814; @{} &#30340;&#21152;&#20837;&#65281;'''</span>

<span style="color: #a0522d;">help_info</span> = <span style="color: #8b2252;">'''&#128515; &#35752;&#35770;&#20027;&#39064;</span>
<span style="color: #8b2252;">&#183; &#19981;&#38480;&#21046;&#20854;&#20182;&#35805;&#39064;&#65292;&#35831;&#21306;&#20998;&#20248;&#20808;&#32423;</span>
<span style="color: #8b2252;">&#183; &#25903;&#25345;&#20998;&#20139;&#23545;&#32676;&#21592;&#26377;&#20215;&#20540;&#30340;&#20449;&#24687;</span>

<span style="color: #8b2252;">&#9888;&#65039; &#27880;&#24847;&#20107;&#39033;</span>
<span style="color: #8b2252;">&#183; &#38500;&#32676;&#20027;&#22806;&#65292;&#21247;&#22312;&#32676;&#20869;&#20351;&#29992;&#26426;&#22120;&#20154;</span>
<span style="color: #8b2252;">&#183; &#20005;&#31105;&#28784;&#20135;/&#40657;&#20135;&#30456;&#20851;&#20869;&#23481;&#35805;&#39064;</span>
<span style="color: #8b2252;">&#183; &#35831;&#21247;&#21457;&#24067;&#23545;&#32676;&#21592;&#26080;&#20215;&#20540;&#30340;&#24191;&#21578;</span>

<span style="color: #8b2252;">&#128110; &#25237;&#31080;&#31227;&#20986;</span>
<span style="color: #8b2252;">&#183; &#31227;&#20986;&#21518;&#23558;&#34987;&#25289;&#40657; 24 &#23567;&#26102;</span>
<span style="color: #8b2252;">&#183; &#35831;&#22312;&#20102;&#35299;&#20107;&#22240;&#21518;&#35880;&#24910;&#25237;&#31080;</span>
<span style="color: #8b2252;">&#183; &#21629;&#20196;&#26684;&#24335;: "&#31227;&#20986; @&#20154;&#21592;"</span>
<span style="color: #8b2252;">'''</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">---------------- &#37197;&#32622;&#32467;&#26463; ----------------</span>


logging.basicConfig(level=logging.DEBUG)

<span style="color: #a0522d;">qr_path</span> = <span style="color: #8b2252;">'qrcode.png'</span>

<span style="color: #a0522d;">process</span> = psutil.Process()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">qr_callback</span>(**kwargs):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(qr_path, <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> fp:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   fp.write(kwargs[<span style="color: #8b2252;">'qrcode'</span>])

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_restart</span>():
<span style="background-color: #f2f2f2;"> </span>   os.execv(sys.executable, [sys.executable] + sys.argv)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_status_text</span>():
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">uptime</span> = datetime.datetime.now() - datetime.datetime.fromtimestamp(process.create_time())
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">memory_usage</span> = process.memory_info().rss

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">globals</span>().get(<span style="color: #8b2252;">'bot'</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">messages</span> = bot.messages
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">messages</span> = <span style="color: #483d8b;">list</span>()

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'[now] {now:%H:%M:%S}\n[uptime] {uptime}\n[memory] {memory}\n[messages] {messages}'</span>.<span style="color: #483d8b;">format</span>(
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   now=datetime.datetime.now(),
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   uptime=<span style="color: #483d8b;">str</span>(uptime).split(<span style="color: #8b2252;">'.'</span>)[0],
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   memory=<span style="color: #8b2252;">'{:.2f} MB'</span>.<span style="color: #483d8b;">format</span>(memory_usage / 1024 ** 2),
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   messages=<span style="color: #483d8b;">len</span>(messages)
<span style="background-color: #f2f2f2;"> </span>   )

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">remove_qr</span>():
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> os.path.isfile(qr_path):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">noinspection PyBroadException</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">try</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   os.remove(qr_path)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">except</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">pass</span>

<span style="color: #a0522d;">bot</span> = Bot(<span style="color: #8b2252;">'bot.pkl'</span>,console_qr=1,login_callback=remove_qr,logout_callback=_restart)
<span style="color: #a0522d;">bot.auto_mark_as_read</span> = <span style="color: #008b8b;">True</span>

<span style="color: #a020f0;">if</span> bot.<span style="color: #a020f0;">self</span>.name != bot_nick_name:
<span style="background-color: #f2f2f2;"> </span>   logging.error(<span style="color: #8b2252;">'Wrong User!'</span>)
<span style="background-color: #f2f2f2;"> </span>   bot.logout()
<span style="background-color: #f2f2f2;"> </span>   _restart()
<span style="color: #b22222;"># </span><span style="color: #b22222;">bot.chats(update=True)</span>
bot.enable_puid(<span style="color: #8b2252;">'bot.puid'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#26368;&#26032;&#30340;&#31649;&#29702;&#21592;&#20449;&#24687;</span>
<span style="color: #a0522d;">admin_puids_list</span>=[]
<span style="color: #a020f0;">for</span> admin_manger <span style="color: #a020f0;">in</span> admin_mangers_name:
<span style="background-color: #f2f2f2;"> </span>   admin_puids_list.append(bot.friends(update=<span style="color: #008b8b;">True</span>).search(admin_manger)[0].puid)
<span style="color: #a0522d;">admin_puids</span> = <span style="color: #483d8b;">tuple</span>(admin_puids_list)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#31649;&#29702;&#32676;&#30340;&#26368;&#26032;puid</span>
<span style="color: #a0522d;">admin_group_puid</span> = bot.groups(update=<span style="color: #008b8b;">True</span>).search(admin_group_name)[0].puid

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#26368;&#26032;&#31649;&#29702;&#30340;&#32676;&#32452;puid</span>
<span style="color: #a0522d;">group_puids_list</span>=[]
<span style="color: #a020f0;">for</span> group <span style="color: #a020f0;">in</span> groups_name:
<span style="background-color: #f2f2f2;"> </span>   group_puids_list.append(bot.groups(update=<span style="color: #008b8b;">True</span>).search(group)[0].puid)
<span style="color: #a0522d;">group_puids</span> = <span style="color: #483d8b;">tuple</span>(group_puids_list)


<span style="color: #a0522d;">admin_group</span> = bot.groups().search(puid=admin_group_puid)[0]
<span style="color: #a0522d;">groups</span> = <span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: bot.groups().search(puid=x)[0], group_puids))

<span style="color: #a0522d;">admins</span> = *<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: bot.friends().search(puid=x)[0], admin_puids), bot.<span style="color: #a020f0;">self</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#32842;&#22825;&#26426;&#22120;&#20154;</span>
<span style="color: #a0522d;">tuling</span> = Tuling(api_key=<span style="color: #8b2252;">'61eea024ed154d8f9d8a33e98547057a'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#20154;&#20837;&#32676;&#36890;&#30693;&#30340;&#21305;&#37197;&#27491;&#21017;</span>
<span style="color: #a0522d;">rp_new_member_name</span> = (
<span style="background-color: #f2f2f2;"> </span>   re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'^"(.+)"&#36890;&#36807;'</span>),
<span style="background-color: #f2f2f2;"> </span>   re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'&#36992;&#35831;"(.+)"&#21152;&#20837;'</span>),
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36828;&#31243;&#36386;&#20154;&#21629;&#20196;: &#31227;&#20986; @&lt;&#38656;&#35201;&#34987;&#31227;&#20986;&#30340;&#20154;&gt;</span>
<span style="color: #a0522d;">rp_kick</span> = re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'^&#31227;&#20986;\s*@(.+?)(?:\u2005?\s*$)'</span>)
<span style="color: #a0522d;">kick_votes</span> = KickVotes(300)
<span style="color: #a0522d;">votes_to_kick</span> = 5
<span style="color: #a0522d;">black_list</span> = TimedList()


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">from_admin</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#21028;&#26029; msg &#30340;&#21457;&#36865;&#32773;&#26159;&#21542;&#20026;&#31649;&#29702;&#21592;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   """</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">isinstance</span>(msg, Message):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">TypeError</span>(<span style="color: #8b2252;">'expected Message, got {}'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">type</span>(msg)))
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">from_user</span> = msg.member <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(msg.chat, Group) <span style="color: #a020f0;">else</span> msg.sender
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> from_user <span style="color: #a020f0;">in</span> admins


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">admin_auth</span>(func):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#35013;&#39280;&#22120;: &#39564;&#35777;&#20989;&#25968;&#30340;&#31532; 1 &#20010;&#21442;&#25968; msg &#26159;&#21542;&#26469;&#33258; admins</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   """</span>

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #228b22;">@wraps</span>(func)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">wrapped</span>(*args, **kwargs):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">msg</span> = args[0]

<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> from_admin(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> func(*args, **kwargs)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">ValueError</span>(<span style="color: #8b2252;">'Wrong admin:\n{}'</span>.<span style="color: #483d8b;">format</span>(msg))

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> wrapped


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">send_iter</span>(receiver, iterable):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#29992;&#36845;&#20195;&#30340;&#26041;&#24335;&#21457;&#36865;&#22810;&#26465;&#28040;&#24687;</span>

<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   :param receiver: &#25509;&#25910;&#32773;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   :param iterable: &#21487;&#36845;&#20195;&#23545;&#35937;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   """</span>

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(iterable, <span style="color: #483d8b;">str</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">TypeError</span>

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> msg <span style="color: #a020f0;">in</span> iterable:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   receiver.send(msg)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">update_groups</span>():
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">yield</span> <span style="color: #8b2252;">'updating groups...'</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> _group <span style="color: #a020f0;">in</span> groups:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   _group.update_group()
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">yield</span> <span style="color: #8b2252;">'{}: {}'</span>.<span style="color: #483d8b;">format</span>(_group.name, <span style="color: #483d8b;">len</span>(_group))


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">status_text</span>():
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">yield</span> _status_text()


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#26102;&#25253;&#21578;&#36827;&#31243;&#29366;&#24577;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">heartbeat</span>():
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">while</span> bot.alive:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   time.sleep(600)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">noinspection PyBroadException</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">try</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   send_iter(admin_group, status_text())
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">except</span> ResponseError <span style="color: #a020f0;">as</span> e:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> 1100 &lt;= e.err_code &lt;= 1102:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logger.critical(<span style="color: #8b2252;">'went offline: {}'</span>.<span style="color: #483d8b;">format</span>(e))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   _restart()
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">except</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logger.exception(<span style="color: #8b2252;">'failed to report heartbeat:\n'</span>)


start_new_thread(heartbeat)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">remote_eval</span>(source):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">try</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">ret</span> = <span style="color: #483d8b;">eval</span>(source, <span style="color: #483d8b;">globals</span>())
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">except</span> (<span style="color: #228b22;">SyntaxError</span>, <span style="color: #228b22;">NameError</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">ValueError</span>(<span style="color: #8b2252;">'got SyntaxError or NameError in source'</span>)

<span style="background-color: #f2f2f2;"> </span>   logger.info(<span style="color: #8b2252;">'remote eval executed:\n{}'</span>.<span style="color: #483d8b;">format</span>(source))
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">yield</span> pformat(ret)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">remote_shell</span>(command):
<span style="background-color: #f2f2f2;"> </span>   logger.info(<span style="color: #8b2252;">'executing remote shell cmd:\n{}'</span>.<span style="color: #483d8b;">format</span>(command))
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">r</span> = subprocess.run(
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   command, shell=<span style="color: #008b8b;">True</span>,
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   stdout=subprocess.PIPE,
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   stderr=subprocess.STDOUT,
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   universal_newlines=<span style="color: #008b8b;">True</span>
<span style="background-color: #f2f2f2;"> </span>   )
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> r.stdout:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">yield</span> r.stdout
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">yield</span> <span style="color: #8b2252;">'[OK]'</span>


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">restart</span>():
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">yield</span> <span style="color: #8b2252;">'restarting bot...'</span>
<span style="background-color: #f2f2f2;"> </span>   bot.dump_login_status()
<span style="background-color: #f2f2f2;"> </span>   _restart()


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">latency</span>():
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">yield</span> <span style="color: #8b2252;">'{:.2f}'</span>.<span style="color: #483d8b;">format</span>(bot.messages[-1].latency)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36828;&#31243;&#21629;&#20196; (&#21333;&#29420;&#21457;&#32473;&#26426;&#22120;&#20154;&#30340;&#28040;&#24687;)</span>
<span style="color: #a0522d;">remote_orders</span> = {
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'g'</span>: update_groups,
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'s'</span>: status_text,
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'r'</span>: restart,
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'l'</span>: latency,
}


<span style="color: #228b22;">@admin_auth</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">server_mgmt</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#26381;&#21153;&#22120;&#31649;&#29702;:</span>

<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   </span><span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#33509;&#28040;&#24687;&#25991;&#26412;&#20026;&#20026;&#36828;&#31243;&#21629;&#20196;&#65292;&#21017;&#25191;&#34892;&#23545;&#24212;&#20989;&#25968;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   </span><span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#33509;&#28040;&#24687;&#25991;&#26412;&#20197; ! &#24320;&#22836;&#65292;&#21017;&#20316;&#20026; shell &#21629;&#20196;&#25191;&#34892;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   </span><span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#33509;&#19981;&#28385;&#36275;&#20197;&#19978;&#65292;&#21017;&#23581;&#35797;&#30452;&#25509;&#23558; msg.text &#20316;&#20026; Python &#20195;&#30721;&#25191;&#34892;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   """</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">order</span> = remote_orders.get(msg.text.strip())
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> order:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logger.info(<span style="color: #8b2252;">'executing remote order: {}'</span>.<span style="color: #483d8b;">format</span>(order.<span style="color: #483d8b;">__name__</span>))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   send_iter(msg.chat, order())
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">elif</span> msg.text.startswith(<span style="color: #8b2252;">'!'</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">command</span> = msg.text[1:]
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   send_iter(msg.chat, remote_shell(command))
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   send_iter(msg.chat, remote_eval(msg.text))


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">reply_by_keyword</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> reply, keywords <span style="color: #a020f0;">in</span> kw_replies.items():
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> kw <span style="color: #a020f0;">in</span> keywords:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> kw <span style="color: #a020f0;">in</span> msg.text.lower():
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logger.info(<span style="color: #8b2252;">'reply by keyword: \n{}: "{}"\nreplied: "{}"'</span>.<span style="color: #483d8b;">format</span>(
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   (msg.member <span style="color: #a020f0;">or</span> msg.chat).name, msg.text, reply))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   msg.reply(reply)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> reply


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;&#20837;&#32676;&#21475;&#20196;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">valid</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> group_code <span style="color: #a020f0;">in</span> msg.text.lower()


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#21160;&#36873;&#25321;&#26410;&#28385;&#30340;&#32676;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_group</span>():
<span style="background-color: #f2f2f2;"> </span>   groups.sort(key=<span style="color: #483d8b;">len</span>, reverse=<span style="color: #008b8b;">True</span>)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> _group <span style="color: #a020f0;">in</span> groups:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(_group) &lt; 490:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> _group
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logger.warning(<span style="color: #8b2252;">'&#32676;&#37117;&#28385;&#21862;&#65281;'</span>)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> groups[-1]


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35745;&#31639;&#27599;&#20010;&#29992;&#25143;&#34987;&#36992;&#35831;&#30340;&#27425;&#25968;</span>
<span style="color: #a0522d;">invite_counter</span> = Counter()
<span style="color: #a0522d;">invite_lock</span> = threading.Lock()


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36992;&#35831;&#20837;&#32676;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">invite</span>(user):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">joined</span> = <span style="color: #483d8b;">list</span>()
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> group <span style="color: #a020f0;">in</span> groups:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> user <span style="color: #a020f0;">in</span> group:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   joined.append(group)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> joined:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">joined_nick_names</span> = <span style="color: #8b2252;">'\n'</span>.join(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: x.nick_name, joined))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logger.info(<span style="color: #8b2252;">'{} is already in\n{}'</span>.<span style="color: #483d8b;">format</span>(user, joined_nick_names))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   user.send(<span style="color: #8b2252;">'&#20320;&#24050;&#21152;&#20837;&#20102;\n{}'</span>.<span style="color: #483d8b;">format</span>(joined_nick_names))
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">with</span> invite_lock:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> invite_counter.get(user, 0) &lt; 2:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">group</span> = get_group()
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   user.send(<span style="color: #8b2252;">'&#39564;&#35777;&#36890;&#36807; [&#22079;&#21704;]'</span>)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   group.add_members(user, use_invitation=<span style="color: #008b8b;">True</span>)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   invite_counter.update([user])
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   user.send(<span style="color: #8b2252;">'&#20320;&#30340;&#21463;&#36992;&#27425;&#25968;&#24050;&#36798;&#26368;&#22823;&#38480;&#21046; &#128567;'</span>)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38480;&#21046;&#39057;&#29575;: &#25351;&#23450;&#21608;&#26399;&#20869;&#36229;&#36807;&#28040;&#24687;&#26465;&#25968;&#65292;&#30452;&#25509;&#22238;&#22797; "&#128586;"</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">freq_limit</span>(period_secs=10, limit_msgs=4):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">decorator</span>(func):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #228b22;">@wraps</span>(func)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">wrapped</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">now</span> = datetime.datetime.now()
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">period</span> = datetime.timedelta(seconds=period_secs)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">recent_received</span> = 0
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> m <span style="color: #a020f0;">in</span> msg.bot.messages[::-1]:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> m.sender == msg.sender:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> now - m.create_time &gt; period:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">break</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">recent_received</span> += 1

<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> recent_received &gt; limit_msgs:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">isinstance</span>(msg.chat, Group) <span style="color: #a020f0;">or</span> msg.is_at:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&#128586;'</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> func(msg)

<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> wrapped

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> decorator


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_new_member_name</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">itchat 1.2.32 &#29256;&#26412;&#26410;&#26684;&#24335;&#21270;&#32676;&#20013;&#30340; Note &#28040;&#24687;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">from</span> itchat.utils <span style="color: #a020f0;">import</span> msg_formatter
<span style="background-color: #f2f2f2;"> </span>   msg_formatter(msg.raw, <span style="color: #8b2252;">'Text'</span>)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> rp <span style="color: #a020f0;">in</span> rp_new_member_name:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">match</span> = rp.search(msg.text)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> match:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> match.group(1)



<span style="color: #b22222;">#</span><span style="color: #b22222;">def remote_kick(msg):</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">if msg.type is TEXT:</span>
<span style="color: #b22222;">#        </span><span style="color: #b22222;">match = rp_kick.search(msg.text)</span>
<span style="color: #b22222;">#        </span><span style="color: #b22222;">if match:</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">name_to_kick = match.group(1)</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">if not from_admin(msg):</span>
<span style="color: #b22222;">#                </span><span style="color: #b22222;">logger.warning('{} tried to kick {}'.format(</span>
<span style="color: #b22222;">#                    </span><span style="color: #b22222;">msg.member.name, name_to_kick))</span>
<span style="color: #b22222;">#                </span><span style="color: #b22222;">return '&#24863;&#35273;&#26377;&#28857;&#19981;&#23545;&#21170;&#8230; @{}'.format(msg.member.name)</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">member_to_kick = ensure_one(list(filter(</span>
<span style="color: #b22222;">#                </span><span style="color: #b22222;">lambda x: x.name == name_to_kick, msg.chat)))</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">if member_to_kick in admins:</span>
<span style="color: #b22222;">#                </span><span style="color: #b22222;">logger.error('{} tried to kick {} whom was an admin'.format(</span>
<span style="color: #b22222;">#                    </span><span style="color: #b22222;">msg.member.name, member_to_kick.name))</span>
<span style="color: #b22222;">#                </span><span style="color: #b22222;">return '&#26080;&#27861;&#31227;&#20986; @{}'.format(member_to_kick.name)</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">member_to_kick.remove()</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">return '&#25104;&#21151;&#31227;&#20986; @{}'.format(member_to_kick.name)</span>
<span style="color: #b22222;">#</span>

<span style="color: #228b22;">@dont_raise_response_error</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">try_send</span>(chat, msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">"""&#23581;&#35797;&#21457;&#36865;&#28040;&#24687;&#32473;&#25351;&#23450;&#32842;&#22825;&#23545;&#35937;"""</span>

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> chat.is_friend:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   chat.send(msg)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_kick</span>(to_kick, limit_secs=0, msg=<span style="color: #008b8b;">None</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> limit_secs:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21152;&#20837;&#35745;&#26102;&#40657;&#21517;&#21333;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   black_list.<span style="color: #483d8b;">set</span>(to_kick, limit_secs)

<span style="background-color: #f2f2f2;"> </span>   to_kick.remove()
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">ret</span> = <span style="color: #8b2252;">'@{} &#24050;&#34987;&#25104;&#21151;&#31227;&#20986;! &#128520;'</span>.<span style="color: #483d8b;">format</span>(to_kick.name)

<span style="background-color: #f2f2f2;"> </span>   start_new_thread(try_send, kwargs=<span style="color: #483d8b;">dict</span>(chat=to_kick, msg=msg))

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> to_kick <span style="color: #a020f0;">in</span> kick_votes:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">voters</span> = kick_votes[to_kick][0]
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">voters</span> = <span style="color: #8b2252;">'\n'</span>.join(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: <span style="color: #8b2252;">'@{}'</span>.<span style="color: #483d8b;">format</span>(x.name), voters))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">ret</span> += <span style="color: #8b2252;">'\n\n&#25237;&#31080;&#20154;:\n{}'</span>.<span style="color: #483d8b;">format</span>(voters)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> ret


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">remote_kick</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">info_msg</span> = <span style="color: #8b2252;">'&#25265;&#27465;&#65292;&#20320;&#24050;&#34987;{}&#31227;&#20986;&#65292;&#25509;&#19979;&#26469;&#30340; 24 &#23567;&#26102;&#20869;&#65292;&#26426;&#22120;&#20154;&#23558;&#23545;&#20320;&#20445;&#25345;&#27785;&#40664; &#128567;'</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">limit_secs</span> = 3600 * 24

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.<span style="color: #483d8b;">type</span> <span style="color: #a020f0;">is</span> TEXT:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">match</span> = rp_kick.search(msg.text)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> match:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">name_to_kick</span> = match.group(1)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">Todo: &#26377;&#37325;&#21517;&#26102;&#30340;&#22810;&#20010;&#36873;&#25321;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">try</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">member_to_kick</span> = ensure_one(msg.chat.search(name=name_to_kick))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">except</span> <span style="color: #228b22;">ValueError</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">member_to_kick</span> = ensure_one(msg.chat.search(nick_name=name_to_kick))

<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> member_to_kick <span style="color: #a020f0;">in</span> admins:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logger.error(<span style="color: #8b2252;">'{} tried to kick {} whom was an admin'</span>.<span style="color: #483d8b;">format</span>(
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   msg.member.name, member_to_kick.name))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&#26080;&#27861;&#31227;&#20986;&#31649;&#29702;&#21592; @{} &#128567;&#65039;'</span>.<span style="color: #483d8b;">format</span>(member_to_kick.name)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> from_admin(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31649;&#29702;&#21592;: &#30452;&#25509;&#36386;&#20986;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> _kick(member_to_kick, limit_secs, info_msg.<span style="color: #483d8b;">format</span>(<span style="color: #8b2252;">'&#31649;&#29702;&#21592;'</span>))
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20854;&#20182;&#32676;&#25104;&#21592;: &#25237;&#31080;&#36386;&#20986;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">votes</span>, <span style="color: #a0522d;">secs_left</span> = kick_votes.vote(voter=msg.member, to_kick=member_to_kick)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">now</span> = time.time()
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">voted</span> = 0
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> voters, start <span style="color: #a020f0;">in</span> kick_votes.votes.values():
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.member <span style="color: #a020f0;">in</span> voters <span style="color: #a020f0;">and</span> now - start &lt; 600:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">10 &#20998;&#38047;&#20869;&#23581;&#35797;&#25237;&#31080;&#31227;&#20986; 3 &#20010;&#32676;&#21592;&#65292;&#21017;&#35748;&#20026;&#26159;&#24694;&#24847;&#29992;&#25143;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">voted</span> += 1
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> voted &gt;= 3:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   _kick(
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   msg.member, limit_secs,
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'&#25265;&#27465;&#65292;&#20320;&#22240;&#24694;&#24847;&#25237;&#31080;&#32780;&#34987;&#31227;&#20986;&#12290;&#25509;&#19979;&#26469;&#30340; 24 &#23567;&#26102;&#20869;&#65292;&#26426;&#22120;&#20154;&#23558;&#23545;&#20320;&#20445;&#25345;&#27785;&#40664; [&#24736;&#38386;]'</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   )
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&#31227;&#20986;&#20102;&#24694;&#24847;&#25237;&#31080;&#32773; @{} [&#38378;&#30005;]'</span>.<span style="color: #483d8b;">format</span>(msg.member.name)

<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> votes &lt; votes_to_kick:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&#27491;&#22312;&#25237;&#31080;&#31227;&#20986; @{}'</span> \
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>  <span style="color: #8b2252;">'\n&#24403;&#21069; {} / {} &#31080; ({:.0f} &#31186;&#26377;&#25928;)'</span> \
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>  <span style="color: #8b2252;">'\n&#31227;&#20986;&#23558;&#25289;&#40657; 24 &#23567;&#26102; &#128565;'</span> \
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>  <span style="color: #8b2252;">'\n&#35831;&#35880;&#24910;&#25237;&#31080; &#129300;'</span>.<span style="color: #483d8b;">format</span>(name_to_kick, votes, votes_to_kick, secs_left)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">else</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> _kick(member_to_kick, limit_secs, info_msg.<span style="color: #483d8b;">format</span>(<span style="color: #8b2252;">'&#25237;&#31080;'</span>))


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">semi_sync</span>(msg, _groups):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.is_at:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">msg.raw</span>[<span style="color: #8b2252;">'Text'</span>] = get_text_without_at_bot(msg)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.text:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   sync_message_in_groups(
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   msg, _groups, suffix=<span style="color: #8b2252;">'&#8593;&#38548;&#22721;&#28040;&#24687;&#8593;&#22238;&#22797;&#35831;@&#26426;&#22120;&#20154;'</span>)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#28040;&#24687;&#26159;&#21542;&#20026;&#25903;&#25345;&#22238;&#22797;&#30340;&#28040;&#24687;&#31867;&#22411;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">supported_msg_type</span>(msg, reply_unsupported=<span style="color: #008b8b;">False</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">supported</span> = (TEXT,)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">ignored</span> = (SYSTEM, NOTE, FRIENDS)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">fallback_replies</span> = {
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   RECORDING: <span style="color: #8b2252;">'&#128585;'</span>,
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   PICTURE: <span style="color: #8b2252;">'&#128584;'</span>,
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   VIDEO: <span style="color: #8b2252;">'&#128584;'</span>,
<span style="background-color: #f2f2f2;"> </span>   }

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.<span style="color: #483d8b;">type</span> <span style="color: #a020f0;">in</span> supported:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">elif</span> (msg.<span style="color: #483d8b;">type</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> ignored) <span style="color: #a020f0;">and</span> reply_unsupported:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   msg.reply(fallback_replies.get(msg.<span style="color: #483d8b;">type</span>, <span style="color: #8b2252;">'&#128018;'</span>))


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21709;&#24212;&#22909;&#21451;&#35831;&#27714;</span>
<span style="color: #228b22;">@bot.register</span>(msg_types=FRIENDS)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">new_friends</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.card <span style="color: #a020f0;">in</span> black_list:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">user</span> = msg.card.accept()
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> valid(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   invite(user)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21709;&#24212;&#22909;&#21451;&#28040;&#24687;&#65292;&#38480;&#21046;&#39057;&#29575;</span>
<span style="color: #228b22;">@bot.register</span>(Friend)
<span style="color: #228b22;">@freq_limit</span>()
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">exist_friends</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.chat <span style="color: #a020f0;">in</span> black_list:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> supported_msg_type(msg, reply_unsupported=<span style="color: #008b8b;">True</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(msg.chat, User) <span style="color: #a020f0;">and</span> valid(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   invite(msg.sender)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">elif</span> reply_by_keyword(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span>

<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   tuling.do_reply(msg)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25163;&#21160;&#21152;&#20026;&#22909;&#21451;&#21518;&#33258;&#21160;&#21457;&#36865;&#28040;&#24687;</span>
<span style="color: #228b22;">@bot.register</span>(Friend, NOTE)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">manually_added</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'&#29616;&#22312;&#21487;&#20197;&#24320;&#22987;&#32842;&#22825;&#20102;'</span> <span style="color: #a020f0;">in</span> msg.text:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#20110;&#22909;&#21451;&#39564;&#35777;&#20449;&#24687;&#20026; wxpy &#30340;&#65292;&#20250;&#31561;&#24453;&#36992;&#35831;&#23436;&#25104; (&#24182;&#35745;&#20837; invite_counter)</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#20110;&#22909;&#21451;&#39564;&#35777;&#20449;&#24687;&#19981;&#20026; wxpy &#30340;&#65292;&#24310;&#36831;&#21457;&#36865;&#26356;&#23481;&#26131;&#24341;&#36215;&#27880;&#24847;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   time.sleep(3)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">with</span> invite_lock:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.chat <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> invite_counter:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&#20320;&#22909;&#21568;&#65292;{}&#65292;&#36824;&#35760;&#24471;&#21681;&#20204;&#30340;&#20837;&#32676;&#21475;&#20196;&#21527;&#65311;&#22238;&#22797;&#21475;&#20196;&#21363;&#21487;&#33719;&#21462;&#20837;&#32676;&#36992;&#35831;&#12290;'</span>.<span style="color: #483d8b;">format</span>(msg.chat.name)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#20854;&#20182;&#32676;&#20013;&#22238;&#22797;&#34987; @ &#30340;&#28040;&#24687;</span>
<span style="color: #228b22;">@bot.register</span>(Group, TEXT)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">reply_other_group</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> msg.chat <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> groups <span style="color: #a020f0;">and</span> msg.is_at:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> supported_msg_type(msg, reply_unsupported=<span style="color: #008b8b;">True</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   tuling.do_reply(msg)


<span style="color: #b22222;"># </span><span style="color: #b22222;">wxpy &#32676;&#30340;&#28040;&#24687;&#22788;&#29702;</span>
<span style="color: #228b22;">@bot.register</span>(groups, TEXT, except_self=<span style="color: #008b8b;">False</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">wxpy_group</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">kick_msg</span> = remote_kick(msg)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> kick_msg:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> kick_msg
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">elif</span> msg.text.lower().strip() <span style="color: #a020f0;">in</span> (<span style="color: #8b2252;">'&#24110;&#21161;'</span>, <span style="color: #8b2252;">'&#35828;&#26126;'</span>, <span style="color: #8b2252;">'&#35268;&#21017;'</span>, <span style="color: #8b2252;">'help'</span>, <span style="color: #8b2252;">'rule'</span>, <span style="color: #8b2252;">'rules'</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> help_info
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">elif</span> msg.is_at:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'oops&#8230;\n&#26412;&#32676;&#31105;&#27490;&#20351;&#29992;&#26426;&#22120;&#20154;[&#25735;&#22068;]\n&#24819;&#25105;&#23601;&#31169;&#32842;&#21591;[&#23475;&#32670;]'</span>

<span style="color: #228b22;">@bot.register</span>((*admins, admin_group), msg_types=TEXT, except_self=<span style="color: #008b8b;">False</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">reply_admins</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#21709;&#24212;&#36828;&#31243;&#31649;&#29702;&#21592;</span>

<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   &#20869;&#23481;&#35299;&#26512;&#26041;&#24335;&#20248;&#20808;&#32423;&#65306;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   1. &#33509;&#20026;&#36828;&#31243;&#21629;&#20196;&#65292;&#21017;&#25191;&#34892;&#36828;&#31243;&#21629;&#20196; (&#39069;&#22806;&#23450;&#20041;&#65292;&#19968;&#26465;&#21629;&#20196;&#23545;&#24212;&#19968;&#20010;&#20989;&#25968;)</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   2. &#33509;&#28040;&#24687;&#25991;&#26412;&#20197; ! &#24320;&#22836;&#65292;&#21017;&#20316;&#20026; shell &#21629;&#20196;&#25191;&#34892;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   3. &#23581;&#35797;&#20316;&#20026; Python &#20195;&#30721;&#25191;&#34892; (&#21487;&#25191;&#34892;&#22823;&#37096;&#20998; Python &#20195;&#30721;)</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   4. &#33509;&#20197;&#19978;&#19981;&#28385;&#36275;&#25110;&#23581;&#35797;&#22833;&#36133;&#65292;&#21017;&#20316;&#20026;&#26222;&#36890;&#32842;&#22825;&#20869;&#23481;&#22238;&#22797;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   """</span>

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">try</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19978;&#36848;&#30340; 1. 2. 3.</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   server_mgmt(msg)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">except</span> <span style="color: #228b22;">ValueError</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19978;&#36848;&#30340; 4.</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(msg.chat, User):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> exist_friends(msg)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#20154;&#27426;&#36814;&#28040;&#24687;</span>
<span style="color: #228b22;">@bot.register</span>(groups, NOTE)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">welcome</span>(msg):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">name</span> = get_new_member_name(msg)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> name:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> welcome_text.<span style="color: #483d8b;">format</span>(name)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_logger</span>(level=logging.DEBUG, <span style="color: #483d8b;">file</span>=<span style="color: #8b2252;">'bot.log'</span>, mode=<span style="color: #8b2252;">'a'</span>):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">log_formatter</span> = logging.Formatter(<span style="color: #8b2252;">'%(asctime)s %(name)-12s %(levelname)-8s %(message)s'</span>)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">log_formatter_lite</span> = logging.Formatter(<span style="color: #8b2252;">'%(name)s:%(levelname)s:%(message)s'</span>)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">_logger</span> = logging.getLogger()

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> hdlr <span style="color: #a020f0;">in</span> _logger.handlers:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   _logger.removeHandler(hdlr)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;&#21040;&#25991;&#20214;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">file</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">file_hdlr</span> = logging.FileHandler(<span style="color: #483d8b;">file</span>, mode)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   file_hdlr.setFormatter(log_formatter)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   _logger.addHandler(file_hdlr)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;&#21040;&#23631;&#24149;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">console_hdlr</span> = logging.StreamHandler()
<span style="background-color: #f2f2f2;"> </span>   console_hdlr.setLevel(logging.WARNING)
<span style="background-color: #f2f2f2;"> </span>   console_hdlr.setFormatter(log_formatter)
<span style="background-color: #f2f2f2;"> </span>   _logger.addHandler(console_hdlr)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;&#21040;&#36828;&#31243;&#31649;&#29702;&#21592;&#24494;&#20449;</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">wechat_hdlr</span> = WeChatLoggingHandler(admins[0])
<span style="background-color: #f2f2f2;"> </span>   wechat_hdlr.setLevel(logging.WARNING)
<span style="background-color: #f2f2f2;"> </span>   wechat_hdlr.setFormatter(log_formatter_lite)
<span style="background-color: #f2f2f2;"> </span>   _logger.addHandler(wechat_hdlr)

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#26410;&#25429;&#25417;&#24322;&#24120;&#20063;&#21457;&#36865;&#21040;&#26085;&#24535;&#20013;</span>

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">except_hook</span>(*args):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logger.critical(<span style="color: #8b2252;">'UNCAUGHT EXCEPTION:'</span>, exc_info=args)
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   _restart()

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">sys.excepthook</span> = except_hook

<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">for</span> m <span style="color: #a020f0;">in</span> <span style="color: #8b2252;">'requests'</span>, <span style="color: #8b2252;">'urllib3'</span>:
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span>   logging.getLogger(m).setLevel(logging.ERROR)

<span style="background-color: #f2f2f2;"> </span>   _logger.setLevel(level)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> _logger


<span style="color: #a0522d;">logger</span> = get_logger()

send_iter(admin_group, status_text())
bot.dump_login_status()

bot.join()

</pre>
</div></li>
</ol></li>
</ol>
</div>
</div>
<div id="outline-container-org8ab395e" class="outline-3">
<h3 id="org8ab395e"><span class="todo TODO">TODO</span> list</h3>
<div class="outline-text-3" id="text-org8ab395e">
<ol class="org-ol">
<li>添加暂停功能</li>
<li>添加监控VPS信息</li>
</ol>
</div>
</div>
</div>
</div>
</body>
</html>